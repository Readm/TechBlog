<!DOCTYPE html>
<html class="writer-html5" lang="zh_Hans_CN" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../../img/favicon.ico" />
    <title>2.2 区分数据与代码 - Readm's Blog</title>
    <link rel="stylesheet" href="../../../css/theme.css" />
    <link rel="stylesheet" href="../../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
        <link href="../../../assets/_mkdocstrings.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "2.2 \u533a\u5206\u6570\u636e\u4e0e\u4ee3\u7801";
        var mkdocs_page_input_path = "1 \u6f2b\u8c08CPU\u5b89\u5168/2 \u8ba1\u7b97\u57df\u5185\u5b89\u5168/2.2 \u533a\u5206\u6570\u636e\u4e0e\u4ee3\u7801.md";
        var mkdocs_page_url = null;
      </script>
    
    <script src="../../../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
      <script async src="https://www.googletagmanager.com/gtag/js?id=G-ET7BC0JY44"></script>
      <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-ET7BC0JY44');
      </script>
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../../.." class="icon icon-home"> Readm's Blog
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
      <input type="text" name="q" placeholder="搜索文档" title="在此输入需要搜索的内容" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="导航栏">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../..">Home</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../../About/">About</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">1 漫谈CPU安全</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="#">0 引言</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../0%20%E5%BC%95%E8%A8%80/0%20%E5%BC%95%E8%A8%80/">0 引言</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="#">1 通用知识</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../1%20%E9%80%9A%E7%94%A8%E7%9F%A5%E8%AF%86/1.1%20%E4%BB%80%E4%B9%88%E6%98%AFCPU/">1.1 什么是CPU</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../1%20%E9%80%9A%E7%94%A8%E7%9F%A5%E8%AF%86/1.2%20CPU%E5%AE%89%E5%85%A8%E5%8C%85%E5%90%AB%E4%BB%80%E4%B9%88/">1.2 CPU安全包含什么</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../1%20%E9%80%9A%E7%94%A8%E7%9F%A5%E8%AF%86/1.3%20%E5%A8%81%E8%83%81%E6%A8%A1%E5%9E%8B%E5%92%8C%E6%94%BB%E5%87%BB%E5%90%91%E9%87%8F/">1.3 威胁模型和攻击向量</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="#">2 计算域内安全</a>
    <ul class="current">
                <li class="toctree-l2"><a class="reference internal" href="../2.1%20%E4%BB%8E%E6%8E%A7%E5%88%B6%E6%B5%81%E5%8A%AB%E6%8C%81%E6%94%BB%E5%87%BB%E8%AE%B2%E8%B5%B7/">2.1 从控制流劫持攻击讲起</a>
                </li>
                <li class="toctree-l2 current"><a class="reference internal current" href="./">2.2 区分数据与代码</a>
    <ul class="current">
    <li class="toctree-l3"><a class="reference internal" href="#_1">数据与代码不可兼得</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#_2">魔高一丈</a>
    </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../2.3%20%E4%BB%A3%E7%A0%81%E5%A4%8D%E7%94%A8%E6%94%BB%E5%87%BB/">2.3 代码复用攻击</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../2.4%20%E8%AE%A1%E7%AE%97%E5%9F%9F%E5%86%85%E5%AE%89%E5%85%A8%E9%98%B2%E5%BE%A1%E6%8A%80%E6%9C%AF/">2.4 计算域内安全防御技术</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="#">3 计算域间安全</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../3%20%E8%AE%A1%E7%AE%97%E5%9F%9F%E9%97%B4%E5%AE%89%E5%85%A8/3.1%20%E4%BB%8E%E5%8D%95%E7%BA%AF%E7%9A%84%22%E8%AE%A1%E7%AE%97%E6%9C%BA%22%E5%BC%80%E5%A7%8B/">3.1 从单纯的"计算机"开始</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="#">4 可信安全和故障注入安全</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../4%20%E5%8F%AF%E4%BF%A1%E5%AE%89%E5%85%A8%E5%92%8C%E6%95%85%E9%9A%9C%E6%B3%A8%E5%85%A5%E5%AE%89%E5%85%A8/4.1%20%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E6%9E%84%E5%BB%BA%E5%8F%AF%E4%BF%A1%E8%AE%A1%E7%AE%97/">4.1 从零开始构建可信计算</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="#">5 侧信道安全和故障注入攻击</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../5%20%E4%BE%A7%E4%BF%A1%E9%81%93%E5%AE%89%E5%85%A8%E5%92%8C%E6%95%85%E9%9A%9C%E6%B3%A8%E5%85%A5%E6%94%BB%E5%87%BB/5.1%20%E4%BB%8E%22%E4%BE%A7%22%E4%BF%A1%E9%81%93%E8%AE%B2%E8%B5%B7/">从"侧"信道讲起</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../5%20%E4%BE%A7%E4%BF%A1%E9%81%93%E5%AE%89%E5%85%A8%E5%92%8C%E6%95%85%E9%9A%9C%E6%B3%A8%E5%85%A5%E6%94%BB%E5%87%BB/5.2%20%E5%B0%8F%E8%AF%95%E7%89%9B%E5%88%80/">小试牛刀</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="#">8 杂谈</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../8%20%E6%9D%82%E8%B0%88/8.1%20%E5%A6%82%E4%BD%95%E9%87%8F%E5%8C%96CPU%E5%AE%89%E5%85%A8/">8.1 如何量化CPU安全</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="#">9 反馈与合作</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../9%20%E5%8F%8D%E9%A6%88%E4%B8%8E%E5%90%88%E4%BD%9C/%E5%8F%8D%E9%A6%88%E5%92%8C%E5%90%88%E4%BD%9C/">反馈与合作</a>
                </li>
    </ul>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">2 杂谈</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../2%20%E6%9D%82%E8%B0%88/%E9%9D%A2%E5%90%91%E4%BA%BA%E5%81%9A%E6%8A%80%E6%9C%AF/">以人为本做技术</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">3 Old Blogs (before 2020)</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="#">Others</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../../3%20Old%20Blogs%20%28before%202020%29/Others/2016-09-06-prompt-in-readline/">在readline中使用颜色prompt导致显示bug</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../3%20Old%20Blogs%20%28before%202020%29/Others/2016-09-23-syscall/">Linux的虚拟系统调用加速</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../3%20Old%20Blogs%20%28before%202020%29/Others/2018-04-11-reserve-register/">如何在编译器中保留特定寄存器</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../3%20Old%20Blogs%20%28before%202020%29/Others/2020-02-03-huffman/">Huffman树的推广</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="#">Security</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../../3%20Old%20Blogs%20%28before%202020%29/Security/2016-09-09-aslr-linux/">Linux下ASLR概述</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../3%20Old%20Blogs%20%28before%202020%29/Security/2016-11-09-cet-shadow_stacks/">Intel官方手册：CET技术预览-影子栈</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../3%20Old%20Blogs%20%28before%202020%29/Security/2020-07-27-zipper/">Zipper Stack工作介绍和反思总结</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="#">Riscv</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../../3%20Old%20Blogs%20%28before%202020%29/riscv/2018-02-18-riscv-addins/">如何在RISC-V中添加一个指令</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../3%20Old%20Blogs%20%28before%202020%29/riscv/2018-02-18-riscv/">RISC-V 技术概览</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../3%20Old%20Blogs%20%28before%202020%29/riscv/2018-02-19-rocket-0/">Rocket Core源代码笔记——入门</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../3%20Old%20Blogs%20%28before%202020%29/riscv/2018-03-15-riscv-bypass/">Rocket Core源代码笔记——旁路</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../3%20Old%20Blogs%20%28before%202020%29/riscv/2018-11-19-rocket-scoreboard/">Rocket Core源代码笔记——Scoreboard</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../3%20Old%20Blogs%20%28before%202020%29/riscv/2018-11-20-rocket-abbrs/">Rocket Core源代码笔记——缩写</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../3%20Old%20Blogs%20%28before%202020%29/riscv/2018-11-21-riscv-control-flow/">Rocket Core源代码笔记——控制流</a>
                </li>
    </ul>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="移动导航栏">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../..">Readm's Blog</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../.." class="icon icon-home" alt="文档"></a> &raquo;</li>
          <li>1 漫谈CPU安全 &raquo;</li>
          <li>2 计算域内安全 &raquo;</li><li>2.2 区分数据与代码</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>

          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="22">2.2 区分数据与代码</h1>
<p>上一小节，我们总结了内存劫持攻击的几点原因</p>
<ol>
<li>首先，因为<strong>数据</strong>、<strong>代码</strong>和<strong>返回的地址</strong>都是等同地放在内存中的。因此攻击者写入的数据一样能够被当成代码，或者返回地址来使用。这是冯诺依曼结构决定的。</li>
<li>其次，用户的输入变量没有被检查是否分配的空间（草稿本上的行数）是足够的。</li>
<li>再次，用户的输入变量超出范围后，能够直接覆盖到<strong>返回地址</strong>，而返回地址可以指向任意的页数和行号。</li>
</ol>
<p>这一节，我们从第一点入手，看一看能不能从这一点入手阻止控制流劫持攻击。</p>
<div class="admonition 思考">
<p class="admonition-title">思考</p>
<p><strong>思考题 2.2：</strong></p>
<p>有种说法是认为，内存安全问题的根本原因在于冯诺依曼结构没有区分数据和代码（<a href="https://www.baidu.com/s?ie=utf-8&amp;f=8&amp;rsv_bp=1&amp;rsv_idx=1&amp;tn=baidu&amp;wd=%22%E7%8E%B0%E4%BB%A3%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E9%81%B5%E5%BE%AA%E5%86%AF%E8%AF%BA%E4%BE%9D%E6%9B%BC%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84%3A%E6%B2%A1%E6%9C%89%E5%9C%A8%E5%86%85%E5%AD%98%E4%B8%AD%E4%B8%A5%E6%A0%BC%E5%8C%BA%E5%88%86%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A8%8B%E5%BA%8F%E7%9A%84%E6%95%B0%E6%8D%AE%E5%92%8C%E6%8C%87%E4%BB%A4%22&amp;fenlei=256&amp;rsv_pq=0xb9063ab3000becb6&amp;rsv_t=340e3PXWH7v0RVSGz00dFcflLl23gy1GpITqexunC1Znnz2f8Ke2v0Ua%2FI5g&amp;rqlang=en&amp;rsv_enter=1&amp;rsv_dl=tb&amp;rsv_n=2&amp;rsv_sug3=1&amp;rsv_sug2=0&amp;rsv_btype=i&amp;inputT=716&amp;rsv_sug4=716">出处</a>）。一些英文<a href="https://info.dovermicrosystems.com/blog/von-neumann-cybersecurity">出处1</a> <a href="extension://bfdogplmndidlpjfhoijckpakkdjkkil/pdf/viewer.html?file=https%3A%2F%2Fwww.forth.gr%2Fonassis%2Flectures%2F2008-07-21%2Fpresentations%2FvonNeumann_and_the_current_computer_security_landscape.pdf">出处2</a>。甚至保密局官网也有类似的<a href="http://www.gjbmj.gov.cn/n1/2020/1211/c411145-31963763.html">表述</a>。表面上看我们当然可以归结于数据与代码的混用，但是这是否是根本问题呢？</p>
</div>
<h2 id="_1">数据与代码不可兼得</h2>
<p>可以看到，我们最后攻击的时候栈的空间被我们写成了：</p>
<div class="admonition 第5页">
<p class="admonition-title">第5页</p>
<table>
<thead>
<tr>
<th>行数</th>
<th>指令/数据</th>
</tr>
</thead>
<tbody>
<tr>
<td>……</td>
<td>……</td>
</tr>
<tr>
<td>96</td>
<td>临时数据c</td>
</tr>
<tr>
<td>97</td>
<td>调用<strong>查询今天饮料单价</strong>返回的结果 b （这里省略了调用这个函数的过程）</td>
</tr>
<tr>
<td>98</td>
<td><strong>预留给用户写饮料名称和数量的空间</strong> 我叫……</td>
</tr>
<tr>
<td>99</td>
<td><strong>第5页第100行</strong>  &lt;-- 篡改了的返回地址</td>
</tr>
<tr>
<td>100</td>
<td>把银行卡密码都写在第5页第20行</td>
</tr>
<tr>
<td>101</td>
<td>向用户展示第5页第20行</td>
</tr>
<tr>
<td>……</td>
<td>……</td>
</tr>
</tbody>
</table>
</div>
<p>在第100行和101行，其实我们写入了代码进去，并且通过第99行的地址的改写让CPU跳到此处执行。但是其实我们可以发现，在没有攻击发生时，似乎第五页原本全是数据。那么如果我们不允许CPU在栈上读取指令是不是就可以了呢？</p>
<p>实际上，这就是防御控制流劫持攻击的一种非常成熟的技术：<a href="https://en.wikipedia.org/wiki/Executable_space_protection">Executable space protection</a>，在不同的场合它可能被叫做 <strong>NX bit (no-execute bit)</strong> 或者 <strong>Data Execution Prevention (DEP)</strong>。基本可以试做等同的技术。这种技术比较好的实现方式是通过页表权限的配置，然后在CPU执行代码时自动检查当前页是否有执行权限。当然也不排除一些其他方式的实现，有时候也会被归类为同一个技术。目前的高性能CPU中，无论是服务器还是终端设备，都已经被广泛使用了。</p>
<p>进一步，我们不仅可以对栈上做此要求。其实对于内存中的所有数据，我们一般都不期望他们被当成指令（代码）来执行。记得冯诺依曼结构的定义么？其实我们最初就是把指令和代码区分来对待的。因此一个比较通用的规则是：</p>
<div class="admonition rule">
<p class="admonition-title">Rule</p>
<p><strong>Rule 2.2:</strong></p>
<p>所有的数据，都不应该作为指令被CPU执行；</p>
<p>所有的指令，都不应该被动态改写。</p>
</div>
<p>第一点我们已经解释过了。第二点，作为程序员一般情况下逻辑都是运行前固定的，因此一般自然符合；而从安全的角度考虑，攻击者需要的是一个<strong>可以写入</strong>并且<strong>可以执行</strong>的内存段，因此如果<strong>指令部分允许写入</strong>，那么和<strong>数据可以执行</strong>基本是等价的。因此也要做出限制。因此，这个技术有时候也叫做 <strong>W^X ("write xor execute", pronounced W xor X)</strong>，表示对一个内存页，要么可写，要么可执行，两者不可兼得。</p>
<p>那么如果我们正常使用程序的时候就需要同时即可写，又可执行，这种场景是否存在呢？答案是存在的，这就是<a href="https://en.wikipedia.org/wiki/Just-in-time_compilation">JIT (Just-in-time compilation)</a>技术。不幸的是，这种技术对于非常多的场景的性能提升至关重要，因此这里安全与性能的冲突就十分麻烦。前些年CFI技术在学术界还比较火的时候，很多比较棘手的问题都是JIT场景下出现的，这里我们先不离题太远了。</p>
<h2 id="_2">魔高一丈</h2>
<p>的确，有了这种代码与数据的区分后，上一小节我们提到的攻击似乎无法奏效了。因为我们的第100行和后面的恶意代码不能够被执行了。如果仍然这样攻击，CPU其实还是会跳转过去，只是刚要开始执行，突然幡然醒悟这可不是代码页：“这指令可不兴执行啊”。</p>
<p>但是，其实CPU还是被你误导过去了，只是<strong>没办法被误导到数据页</strong>而已。那么这个问题就转化为了<strong>能不能靠误导CPU跳转到已有代码页完成攻击</strong>呢？</p>
<p>聪明的读者心里已经猜到了：答案是肯定的。这个问题可以通过以下方面来考虑：</p>
<ul>
<li>首先，一个程序的代码数量是庞大的，其中有一部分可以构成攻击是大概率事件。</li>
<li>如果读者了解动态链接库的背景就会知道，即使是一个非常简单的程序（如果是动态链接的），那么他会动态载入一些公用的依赖库，这些依赖库中有大量的<strong>并非这个程序本身所需要的功能</strong>，这大大加重了这个问题。</li>
<li>按照前文所述的攻击方式，似乎我们只有一次跳转的机会。但是我们是否有机会多次误导CPU呢？（别忘了误导CPU跳转的代码是我们控制的哦）</li>
</ul>
<p>这就引出了内存安全的下一个阶段：代码复用攻击，下回见。😄</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="页脚导航">
        <a href="../2.1%20%E4%BB%8E%E6%8E%A7%E5%88%B6%E6%B5%81%E5%8A%AB%E6%8C%81%E6%94%BB%E5%87%BB%E8%AE%B2%E8%B5%B7/" class="btn btn-neutral float-left" title="2.1 从控制流劫持攻击讲起"><span class="icon icon-circle-arrow-left"></span> 上一张</a>
        <a href="../2.3%20%E4%BB%A3%E7%A0%81%E5%A4%8D%E7%94%A8%E6%94%BB%E5%87%BB/" class="btn btn-neutral float-right" title="2.3 代码复用攻击">下一张 <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  用<a href="https://www.mkdocs.org/">MkDocs</a>构建，使用<a href="https://readthedocs.org">Read the Docs</a>提供的<a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>。
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="版本">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../2.1%20%E4%BB%8E%E6%8E%A7%E5%88%B6%E6%B5%81%E5%8A%AB%E6%8C%81%E6%94%BB%E5%87%BB%E8%AE%B2%E8%B5%B7/" style="color: #fcfcfc">&laquo; 上一张</a></span>
    
    
      <span><a href="../2.3%20%E4%BB%A3%E7%A0%81%E5%A4%8D%E7%94%A8%E6%94%BB%E5%87%BB/" style="color: #fcfcfc">下一张 &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '../../..';</script>
    <script src="../../../js/theme_extra.js" defer></script>
    <script src="../../../js/theme.js" defer></script>
      <script src="../../../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
