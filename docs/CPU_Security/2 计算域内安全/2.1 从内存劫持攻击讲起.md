# 2.1 从内存劫持攻击讲起

CPU特性中属于计算域内的安全的绝大多数问题都是内存安全问题相关，而内存安全的主要防御目标就是内存劫持攻击。内存劫持攻击即`Control-Flow Hijacking Attack`，而防御技术一般称作`CFI(Control-Flow Integrity)`。

!!! Note
    Google给出的定义可以供参考：

    Control-flow hijacking attacks allow an attacker to subvert a value that is loaded into the program counter of a running program, typically redirecting execution to his own injected code.

### 控制流是什么

所谓控制流，在CPU中其实就是Program Counter，即指向当前CPU执行代码的指针变化所构成的一个流。控制流劫持攻击，就是PC的值被攻击者控制了，使CPU执行的指令不同于本来程序的变成人员的预期，而按照攻击者的设计执行指令。多数情况下，这种劫持是持久的（攻击者会利用一些方式获得稳定的控制），因此攻击者多数情况下都会获得`任意代码执行`的能力。

作为表象，一个程序的功能会完全被攻击者控制。例如本来是一个读入`.mp3`文件并播放音频的程序，读入了攻击者提供的MP3文件，却弹出一个对话框问你要不要看点刺激的，

[>>>点击这里<<<](https://www.bilibili.com/video/BV1va411w7aM/?vd_source=6fb8a3b215292b6f556641fdd6e19db5)

然后你还在犹豫他就给你打开了**（请勿在工作场合打开，作者关心您的个人声誉。）**。

### 最简单的控制流劫持——栈溢出攻击

为了理解为什么会发生如此诡异的事情，我们要理解计算机是如何把一条条指令串联起来的。首先有一个概念叫做：

!!! Note
    [**冯·诺伊曼结构（Von Neumann architecture）**](https://zh.wikipedia.org/zh-cn/%E5%86%AF%C2%B7%E8%AF%BA%E4%BC%8A%E6%9B%BC%E7%BB%93%E6%9E%84)，是一种将程序指令存储器和数据存储器合并在一起的电脑设计概念结构。

不严格的来说，目前商业CPU基本上都可以看做是符合该结构的，即数据、代码都是等价地被放到内存中。我们这里引入一个新的比喻更加方便：

CPU就像一个只会做有限个操作的机器人，而内存就像一个巨大的草稿本。草稿本上每一行都写了数据或者是简单的指令（例如：把第一行和第二行的数据加起来写到第三行）。我们只需要在草稿本上给机器人一个起点（第一页第一行），他就会照着草稿本上写得内容一行接一行执行下去。

!!! Note
    概念  | 类比
    -----|:-----
    CPU  | 只会有限个操作的机器人
    内存 | 机器人面前的一个草稿本
    指令 | 写在草稿本上，告诉机器人要做什么（这就是为啥它叫指令）
    数据 | 要处理的数据也是写在草稿本中数字

比如，我们给第1页写上：

```
1. 把第2页的第1行的数字乘以2写到第2页第3行
2. 把第2页第3行的数字加上3写到第2页第4行
```

这样我们就有了一个把第二页第一行的数字乘以2加上3的程序了！

很明显每次软件要CPU做的事情肯定是不一样的，如果机器人只会一行接一行的运行计算指令，那么它是无法完成复杂的功能的，因此我们需要**跳转指令/分支指令**：比如“做到这里，接下来去第1页第1行接着工作。”有时候还会判断一下条件，即**条件跳转/条件分支**：比如“如果上一行是0，那么去第1页第1行，否则继续下一行。”这样，我们就可以把*将一个数字乘以2加上3*的功能写到第1页第1行了，每次想使用它都写上跳转过去。

!!! Note
    其实，有了计算和跳转功能，就可以构造[图灵机](https://zh.wikipedia.org/wiki/%E5%9B%BE%E7%81%B5%E6%9C%BA)，满足[图灵完备](https://zh.wikipedia.org/wiki/%E5%9C%96%E9%9D%88%E5%AE%8C%E5%82%99%E6%80%A7)了。我们这里不展开了。
